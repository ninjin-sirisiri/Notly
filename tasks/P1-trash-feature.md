---
priority: P1 (高優先度)
status: 未着手
estimated_time: 2-3日
---

# ゴミ箱機能

## 概要
現在、ノートやフォルダを削除すると即座に完全削除されます。誤操作による削除から復旧できるように、ゴミ箱機能を実装します。

## 背景・目的
- **現状の課題**: 
  - 削除が不可逆的で、誤操作時のリカバリーができない
  - ユーザーが削除操作に慎重になりすぎる可能性
- **期待される効果**:
  - 誤削除時の復旧が可能になる
  - 安心してノートを整理できる
  - データロスのリスク低減

## 実装要件

### 機能要件
1. **削除時の動作**
   - ノート・フォルダ削除時、ゴミ箱に移動（物理削除はしない）
   - 削除日時を記録

2. **ゴミ箱UI**
   - サイドバーに「ゴミ箱」エントリを追加
   - ゴミ箱内のノート・フォルダ一覧表示
   - 削除日時の表示

3. **復元機能**
   - ゴミ箱からノート・フォルダを元の場所に復元
   - 元の場所が存在しない場合はルートに復元

4. **完全削除機能**
   - ゴミ箱から個別に完全削除
   - 「ゴミ箱を空にする」で一括完全削除
   - 削除確認ダイアログの表示

5. **自動削除機能（オプション）**
   - ゴミ箱に30日以上あるアイテムを自動完全削除
   - 設定で無効化可能

### 技術要件

#### データベース変更
1. **notesテーブル**
   - `is_deleted` (BOOLEAN) 列を追加
   - `deleted_at` (TIMESTAMP) 列を追加

2. **foldersテーブル**
   - `is_deleted` (BOOLEAN) 列を追加
   - `deleted_at` (TIMESTAMP) 列を追加

#### バックエンド変更
1. **新規コマンド**
   - `restore_note(id)` - ノートを復元
   - `restore_folder(id)` - フォルダを復元
   - `permanently_delete_note(id)` - ノートを完全削除
   - `permanently_delete_folder(id)` - フォルダを完全削除
   - `get_trash_items()` - ゴミ箱内のアイテム取得
   - `empty_trash()` - ゴミ箱を空にする

2. **既存コマンドの変更**
   - `delete_note`: 物理削除ではなく `is_deleted = true` に更新
   - `delete_folder`: 物理削除ではなく `is_deleted = true` に更新
   - `get_all_notes`: `is_deleted = false` のみ取得するようフィルタ
   - `get_all_files_hierarchical`: 同上

#### フロントエンド変更
1. **新しいストア追加**
   - `src/stores/trash.ts` - ゴミ箱の状態管理

2. **UI追加**
   - `src/components/layout/sidebar/TrashItem.tsx` - ゴミ箱エントリ
   - `src/components/trash/TrashView.tsx` - ゴミ箱ビュー
   - `src/components/trash/TrashNoteItem.tsx` - ゴミ箱内ノートアイテム
   - `src/components/trash/TrashFolderItem.tsx` - ゴミ箱内フォルダアイテム

## 実装手順

### Phase 1: データベースとバックエンド
1. マイグレーション作成
   - `is_deleted`, `deleted_at` カラムの追加
2. バックエンドのサービス層に復元・完全削除ロジック追加
3. コマンド実装とテスト

### Phase 2: フロントエンド基本機能
1. ゴミ箱ストアの作成
2. サイドバーにゴミ箱エントリ追加
3. ゴミ箱ビューの実装
4. 削除操作を論理削除に変更

### Phase 3: 復元・完全削除UI
1. 復元ボタンの実装
2. 完全削除ボタンの実装
3. 確認ダイアログの実装

### Phase 4: 自動削除機能（オプション）
1. バックエンドで定期的に古いアイテムをチェック
2. 設定UIの追加

## 設計上の注意点
- フォルダを削除した場合、配下のノート・サブフォルダも一緒にゴミ箱に移動
- 復元時も階層構造を保持したまま復元
- ゴミ箱内でのフォルダ階層表示は簡易的にフラット表示でも可

## 参考資料
- Windows エクスプローラーのゴミ箱
- macOS Finder のゴミ箱
- Notion のゴミ箱機能

## 関連タスク
- なし（独立したタスク）

## 備考
- ユーザーの心理的安全性を高める重要な機能
- Phase 4 の自動削除は後回しでも可
