---
priority: P2 (中優先度)
status: 未着手
estimated_time: 3-4日
---

# ノート編集履歴・バージョン管理

## 概要
ノートの編集履歴を保存し、過去のバージョンに戻せるようにします。誤った編集からの復旧や変更履歴の確認が可能になります。

## 背景・目的
- **現状の課題**: 
  - 編集前の状態に戻せない
  - 変更の追跡ができない
  - 誤編集のリカバリーができない
- **期待される効果**:
  - 安心して編集できる（いつでも戻せる）
  - 変更履歴の可視化
  - データロスの防止

## 実装要件

### 機能要件
1. **自動バージョン保存**
   - 保存時に自動的に履歴を記録
   - または一定間隔（例: 5分ごと）で自動保存

2. **履歴表示**
   - ノートの編集履歴一覧を表示
   - 各バージョンのタイムスタンプと差分サイズ

3. **バージョン復元**
   - 過去のバージョンをプレビュー
   - 選択したバージョンに復元

4. **差分表示**
   - 2つのバージョン間の差分を表示（diff）
   - 追加・削除・変更部分のハイライト

5. **履歴の削除**
   - 古い履歴の自動削除（例: 30日以上前）
   - 手動での履歴削除

### データベース設計

#### 新規テーブル: `note_versions`
- `id` (INTEGER, PRIMARY KEY)
- `note_id` (INTEGER, FOREIGN KEY -> notes.id)
- `content` (TEXT, NOT NULL) - その時点でのノートの内容
- `created_at` (TIMESTAMP) - バージョン作成日時
- INDEX on `note_id`, `created_at`

#### 設計の選択肢
**Option 1**: フルコンテンツ保存
- 各バージョンでノート全体を保存
- シンプルだがストレージ効率が悪い

**Option 2**: 差分保存（Delta）
- 前バージョンとの差分のみ保存
- ストレージ効率が良いが実装が複雑

→ **Phase 1 では Option 1 で実装し、後から Option 2 に移行**

### 技術要件

#### バックエンド
1. **新規コマンド**
   - `create_note_version(note_id, content)` - バージョン作成
   - `get_note_versions(note_id)` - ノートの全バージョン取得
   - `get_note_version(version_id)` - 特定バージョンの取得
   - `restore_note_version(note_id, version_id)` - バージョン復元
   - `delete_old_versions(days)` - 古い履歴削除

2. **既存コマンドの拡張**
   - `update_note()`: 保存時に自動的にバージョンを作成

3. **Rustライブラリ（差分機能）**
   - `similar` / `diff` - テキスト差分計算

#### フロントエンド
1. **UI追加**
   - `src/components/history/VersionHistory.tsx` - 履歴一覧ダイアログ
   - `src/components/history/VersionPreview.tsx` - バージョンプレビュー
   - `src/components/history/DiffView.tsx` - 差分表示
   - ノートヘッダーに「履歴」ボタン追加

2. **差分表示ライブラリ**
   - `react-diff-viewer` - 差分表示用

## 実装手順

### Phase 1: 基本履歴機能（フルコンテンツ保存）
1. データベーステーブル作成
2. バージョン作成・取得コマンドの実装
3. 保存時の自動バージョン作成

### Phase 2: 履歴UI
1. 履歴一覧ダイアログの作成
2. バージョンプレビュー機能
3. 復元機能の実装

### Phase 3: 差分表示
1. 差分計算ロジックの実装
2. DiffView コンポーネントの作成
3. 2つのバージョン比較UI

### Phase 4: 最適化（差分保存）
1. デルタベースの保存に移行
2. ストレージ効率の改善

## UI/UXデザイン案

### 履歴ダイアログ
- タイムライン形式で履歴を表示
- 各エントリに日時とサイズ変化を表示
- クリックでプレビュー

### 差分表示
- サイドバイサイド表示
- 追加部分は緑、削除部分は赤でハイライト

## 設計上の注意点
- ストレージ消費量の管理（古い履歴の自動削除）
- パフォーマンス（大量の履歴がある場合）
- バージョン数の上限設定（例: 最大100バージョン）

## 参考資料
- Google Docs のバージョン履歴
- Notion のページ履歴
- Git の差分表示

## 関連タスク
- なし（独立したタスク）

## 備考
- データロスのリスクを大幅に減らす重要な機能
- Phase 4 の差分保存は後回しでも可（フルコンテンツ保存でも十分機能する）
- 自動保存の頻度は設定可能にすると良い
